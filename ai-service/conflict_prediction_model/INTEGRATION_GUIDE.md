# ML Model Integration Guide

## ğŸš€ How the Model is Exploited in the Project

The conflict prediction model is integrated into the Golden Retriever platform through **3 main components**:

---

## 1. ML Prediction API (`ml_prediction_api.py`)
**Port: 5003**

### What it does:
- Serves the trained ML model via REST API
- Accepts live train data and predicts network conflicts
- Provides probability scores and risk levels

### Key Endpoints:

#### `POST /api/ml/analyze-network`
Analyzes live network state and predicts conflicts:
```json
{
  "network_id": "FS",
  "trains": [
    {
      "train_id": "train-123",
      "speed": 55.0,
      "delay": 2.0,
      "is_anomaly": false,
      "nearby_trains": 15
    }
  ]
}
```

**Response:**
```json
{
  "success": true,
  "network_id": "FS",
  "prediction": {
    "is_conflict": true,
    "probability": 0.67,
    "confidence": 0.67,
    "risk_level": "HIGH"
  },
  "alert": {
    "should_alert": true,
    "severity": "high",
    "recommended_action": "Monitor closely and prepare intervention",
    "contributing_factors": [
      "High anomaly rate (35.2%)",
      "Significant delays (22.5% of trains)"
    ]
  }
}
```

#### `POST /api/ml/predict-network-conflict`
Simple prediction for pre-aggregated network features.

#### `GET /api/ml/model-info`
Returns model metadata and performance metrics.

---

## 2. ML Integration Service (`ml_integration_service.py`)

### What it does:
- **Continuous monitoring** - Runs every 30 seconds
- Fetches active trains from backend
- Groups trains by network
- Calls ML API for predictions
- **Automatically creates pre-conflict alerts** in Digital Twin

### Flow:
```
Backend (trains) â†’ ML API (predict) â†’ Digital Twin (alert) â†’ Frontend (display)
```

### Alert Generation Logic:
```python
if conflict_probability > 40%:
    - Create pre-conflict alert
    - Set severity (low/medium/high/critical)
    - Include contributing factors
    - Provide recommended actions
```

---

## 3. Frontend Integration

### Pre-Conflict Alerts Component
The alerts generated by ML predictions appear in the dashboard's **Pre-Conflict Alerts** section with:
- ğŸ”´ Critical: probability â‰¥ 80%
- ğŸŸ  High: probability â‰¥ 60%
- ğŸŸ¡ Medium: probability â‰¥ 40%

---

## ğŸ¯ Use Cases

### 1. **Proactive Monitoring**
- Predict conflicts **before they materialize**
- Early warning system for operations teams
- Reduce reactive incident response

### 2. **Risk Assessment**
- Real-time risk scoring for each network
- Prioritize attention to high-risk networks
- Data-driven decision making

### 3. **Operational Insights**
- Understand contributing factors (delays, anomalies, congestion)
- Identify patterns leading to conflicts
- Improve scheduling and resource allocation

### 4. **Performance Analytics**
- Track prediction accuracy over time
- Measure false positive/negative rates
- Continuous model improvement

---

## ğŸ”§ How to Start

### Step 1: Start ML API
```bash
.\start-ml-api.bat
```
Starts Flask server on port 5003

### Step 2: Start ML Integration Service
```bash
.\start-ml-integration.bat
```
Begins monitoring and generating alerts

### Step 3: View Alerts
Open dashboard â†’ **Pre-Conflict Alerts** section shows ML-generated warnings

---

## ğŸ“Š Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   FRONTEND                          â”‚
â”‚            (Pre-Conflict Alerts UI)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BACKEND (Port 5000)                    â”‚
â”‚         - Proxy to services                         â”‚
â”‚         - Serves active trains                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚             â”‚
           â†“             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DIGITAL TWIN   â”‚  â”‚   ML INTEGRATION SERVICE     â”‚
â”‚  (Port 5002)    â”‚â†â”€â”‚  (Python Monitor Script)     â”‚
â”‚                 â”‚  â”‚  - Fetches trains            â”‚
â”‚  - Stores       â”‚  â”‚  - Calls ML API              â”‚
â”‚    alerts       â”‚  â”‚  - Creates alerts            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â†“
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   ML PREDICTION API         â”‚
                     â”‚   (Port 5003)               â”‚
                     â”‚                             â”‚
                     â”‚  - Loads trained model      â”‚
                     â”‚  - Aggregates train data    â”‚
                     â”‚  - Predicts conflicts       â”‚
                     â”‚  - Returns probabilities    â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Model Capabilities

**Input Features (29 total):**
- Network metrics: train count, speeds, delays
- Anomaly indicators: anomaly count, ratio
- Proximity metrics: nearest distances, crowding
- Interaction features: speed-delay correlations
- Temporal trends: rolling averages

**Output:**
- Binary prediction (conflict/no conflict)
- Probability score (0-100%)
- Risk level (MINIMAL/LOW/MEDIUM/HIGH/CRITICAL)
- Contributing factors identification

**Performance:**
- Accuracy: ~91%
- Handles imbalanced data (8.6% conflict rate)
- Conservative predictions (high precision)

---

## ğŸš¨ Alert Severity Levels

| Probability | Risk Level | Severity | Action |
|------------|------------|----------|--------|
| â‰¥ 80% | CRITICAL | ğŸ”´ Critical | IMMEDIATE ACTION REQUIRED |
| â‰¥ 60% | HIGH | ğŸŸ  High | Monitor closely, prepare intervention |
| â‰¥ 40% | MEDIUM | ğŸŸ¡ Medium | Increased monitoring |
| â‰¥ 20% | LOW | ğŸŸ¢ Low | Normal operations |
| < 20% | MINIMAL | âšª Minimal | No action needed |

---

## ğŸ“ˆ Future Enhancements

1. **Temporal Predictions**: Predict conflicts 5-15 minutes ahead
2. **Ensemble Models**: Combine multiple models for better accuracy
3. **Online Learning**: Update model with new conflict data
4. **Explainability**: SHAP values for prediction explanations
5. **A/B Testing**: Test different models in production
6. **Feedback Loop**: Use actual outcomes to improve predictions

---

## ğŸ”‘ Key Benefits

âœ… **Proactive**: Detect issues before they escalate  
âœ… **Automated**: No manual monitoring needed  
âœ… **Intelligent**: ML learns patterns humans might miss  
âœ… **Scalable**: Handles multiple networks simultaneously  
âœ… **Actionable**: Provides specific recommended actions  
âœ… **Transparent**: Shows contributing factors  

---

## ğŸ› ï¸ API Examples

### Test ML API directly:
```bash
curl -X POST http://localhost:5003/api/ml/analyze-network \
  -H "Content-Type: application/json" \
  -d '{
    "network_id": "FS",
    "trains": [...]
  }'
```

### Check model health:
```bash
curl http://localhost:5003/api/ml/health
```

### Get model info:
```bash
curl http://localhost:5003/api/ml/model-info
```

---

## ğŸ“ Notes

- The ML service runs **independently** of the main platform
- Can be started/stopped without affecting other services
- Predictions are **cached for 30 seconds** to reduce computation
- Failed predictions don't crash the system (graceful degradation)
- All predictions are **logged** for later analysis
